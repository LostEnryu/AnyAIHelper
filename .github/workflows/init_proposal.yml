name: Init Issue → AI Prompt Generation

on:
  issues:
    types: [opened]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  generate_proposals:
    if: startsWith(github.event.issue.title, '[Init]')
    runs-on: ubuntu-latest

    steps:
      # 0. Gitを用意
      - name: Prepare git environment
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      # 1. ai_helperブランチがあるかどうかチェック
      - name: Ensure ai_helper branch exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git ls-remote --exit-code origin ai_helper; then
            gh api repos/${{ github.repository }}/git/refs \
              -X POST -f ref="refs/heads/ai_helper" -f sha=$(git rev-parse origin/main)
          fi

      # 2. リポジトリをチェックアウト(ai_helper)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ai_helper
          path: ai_helper_branch

      # 3. Pythonセットアップ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 4. Stepのチェック
      - name: Extract Step value
        id: extract
        run: |
          cd ai_helper_branch
          echo "${{ github.event.issue.body }}" > issue_body.txt
          STEP=$(python ai_helper/scripts/check_init_issue_step.py --issue-body-file issue_body.txt)
          echo "step=$STEP" >> $GITHUB_OUTPUT
          cd ..

      # 5. Python依存関係インストール
      - name: Install dependencies
        if: ${{ steps.extract.outputs.step == 'Draft' }}
        env:
          REQ_FILE: ai_helper_branch/ai_helper/requirements.txt
        run: |
          python -m pip install --upgrade pip
          if [ -f "$REQ_FILE" ] ; then
            pip install -r "$REQ_FILE"
          else
            echo "No requiremetns.txt found, skipping install"
          fi

      # 6. Pythonスクリプトでフォルダ作成・プロンプト生成・コミットまで実行
      - name: Run init prompt generator
        if: ${{ steps.extract.outputs.step == 'Draft' }}
        run: |          
          cd ai_helper_branch
          python ai_helper/scripts/init_prompt_generator.py \
            --issue-number ${{ github.event.issue.number }} \
            --actor "${{ github.actor }}" \
            --repo "${{ github.repository }}"

      # 7. コメントを投稿
      - name: Add comment on issue
        run: |
          python ai_helper/scripts/comment_on_issue.py \
            --issue-number "${{ github.event.issue.number }}" \
            --type init \
            --range "00_プロジェクト概要_プロンプト.txt" "11_リスク管理_プロンプト.txt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}